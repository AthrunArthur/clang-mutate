# -*- org -*-
#+Options: ^:nil

* Clang LibTooling interface
The llvm IRC room suggests using a "tooling interface".
http://clang.llvm.org/docs/LibTooling.html

The tooling interface will run a "front end action".
http://clang.llvm.org/docs/RAVFrontendAction.html

Clang tools depend on the existence of Compilation Databases.
http://clang.llvm.org/docs/JSONCompilationDatabase.html

* Notes Issues and Tasks [2/4]
** TODO better selection of AST nodes to visit
- what can we visit http://clang.llvm.org/docs/RAVFrontendAction.html
- lets not visit tiny statements

** TODO nesting of numbered statements
Ensure that the numbers are applied from the outside-in rather than
the inside out, e.g., in the following =/* 1[ */= should be before
both =/* 2[ */= and =/* 3[ */=.

: /* numbered using clang-mutate */
: int main(int argc, char *argv[])
: /* 0[ */{
:   /* 3[ *//* 2[ *//* 1[ */puts/* ]2 *//* ]3 */(/* 5[ *//* 4[ */"hello"/* ]4 *//* ]5 */)/* ]1 */;
:   /* 6[ */return /* 7[ */0/* ]6 *//* ]7 */;
: }/* ]0 */

** known working versions of LLVM and Clang
LLVM
: Path: .
: Working Copy Root Path: /usr/local/src/llvm
: URL: http://llvm.org/svn/llvm-project/llvm/trunk
: Repository Root: http://llvm.org/svn/llvm-project
: Repository UUID: 91177308-0d34-0410-b5e6-96231b3b80d8
: Revision: 163018
: Node Kind: directory
: Schedule: normal
: Last Changed Author: hliao
: Last Changed Rev: 163018
: Last Changed Date: 2012-08-31 14:12:31 -0600 (Fri, 31 Aug 2012)

Clang
: Path: .
: Working Copy Root Path: /usr/local/src/llvm/tools/clang
: URL: http://llvm.org/svn/llvm-project/cfe/trunk
: Repository Root: http://llvm.org/svn/llvm-project
: Repository UUID: 91177308-0d34-0410-b5e6-96231b3b80d8
: Revision: 163034
: Node Kind: directory
: Schedule: normal
: Last Changed Author: lattner
: Last Changed Rev: 163034
: Last Changed Date: 2012-08-31 16:39:21 -0600 (Fri, 31 Aug 2012)

** DONE member access into incomplete type
: $ make mutate-tool
: clang++ -I/usr/local/include  -D_DEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -g -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -fPIC -Woverloaded-virtual -Wcast-qual -fno-rtti   -c -o mutate-tool.o mutate-tool.cpp
: mutate-tool.cpp:176:33: error: member access into incomplete type
:       'clang::ASTContext'
:     Visitor.TraverseDecl(Context.getTranslationUnitDecl());
:                                 ^
: /usr/local/include/clang/Basic/Builtins.h:29:9: note: forward
:       declaration of 'clang::ASTContext'
:   class ASTContext;
:         ^
: 1 error generated.
: make: *** [mutate-tool.o] Error 1

http://permalink.gmane.org/gmane.comp.debugging.lldb.devel/982

Suggests stepping back to these versions
|       | git                                      |    svn |
|-------+------------------------------------------+--------|
| llvm  | 61dfa77fce2b6b6261e43334aec060129eac5c6c | 152264 |
| clang | 9ea396a886d46a9329817ad0a8c423510634d889 | 132239 |

** DONE linking problem -- undefined reference to `llvm::createMCAsmParser
*** these work in clang/tools
compiling
: if  clang++ -I/usr/local/src/llvm/include -I/usr/local/src/llvm/tools/clang/tools/clang-check  -D_DEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -I/usr/local/src/llvm/tools/clang/tools/clang-check/../../include -I/usr/local/src/llvm/tools/clang/tools/clang-check/../../include -g -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -fPIC -Woverloaded-virtual -Wcast-qual -fno-strict-aliasing    -pedantic -Wno-long-long -Wall -W -Wno-unused-parameter -Wwrite-strings  -Wcovered-switch-default -c -MMD -MP -MF "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.d.tmp" -MT "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.o" -MT "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.d" ClangCheck.cpp -o /usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.o ; \
:         then /bin/mv -f "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.d.tmp" "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.d"; else /bin/rm "/usr/local/src/llvm/tools/clang/tools/clang-check/Debug+Asserts/ClangCheck.d.tmp"; exit 1; fi
linking
: clang++ -I/usr/local/src/llvm/include -I/usr/local/src/llvm/tools/clang/tools/clang-check  -D_DEBUG -D_GNU_SOURCE -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -I/usr/local/src/llvm/tools/clang/tools/clang-check/../../include -I/usr/local/src/llvm/tools/clang/tools/clang-check/../../include -g -fvisibility-inlines-hidden -fno-exceptions -fno-rtti -fPIC -Woverloaded-virtual -Wcast-qual -fno-strict-aliasing  -g -Wl,-R -Wl,'$ORIGIN/../lib' -Wl,-R -Wl,/usr/local/src/llvm/Debug+Asserts/bin  -L/usr/local/src/llvm/Debug+Asserts/lib -L/usr/local/src/llvm/Debug+Asserts/lib -Wl,--version-script=/usr/local/src/llvm/autoconf/ExportMap.map     -pedantic -Wno-long-long -Wall -W -Wno-unused-parameter -Wwrite-strings  -Wcovered-switch-default  -o mutate-tool mutate-tool.o -lclangFrontend -lclangSerialization -lclangDriver -lclangTooling -lclangParse -lclangSema -lclangAnalysis -lclangEdit -lclangAST -lclangLex -lclangBasic -lLLVM-3.2svn   -lpthread -ldl -lm

replacing clang-check with mutation-tool in the above works

*** finding other references to MCAsmParser
: rgrep createMCAsmParser *
: lib/Sema/SemaStmtAsm.cpp:      Parser(createMCAsmParser(SrcMgr, Ctx, *Str.get(), *MAI));
: lib/Sema/SemaStmtAsm.cpp:      TargetParser(TheTarget->createMCAsmParser(*STI, *Parser));
: tools/driver/cc1as_main.cpp:  OwningPtr<MCAsmParser> Parser(createMCAsmParser(SrcMgr, Ctx,
: tools/driver/cc1as_main.cpp:  OwningPtr<MCTargetAsmParser> TAP(TheTarget->createMCAsmParser(*STI, *Parser));
